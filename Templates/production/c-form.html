{% extends 'c-base.html' %}
{% load static %}
{% block css %}
  <link rel="stylesheet" href="{% static '/codemirror/lib/codemirror.css' %}">
  <script src="{% static '/codemirror/lib/codemirror.js' %}"></script>
  <script src="{% static '/codemirror/addon/selection/active-line.js' %}"></script>
  <script src="{% static '/codemirror/mode/python/python.js' %}"></script>
  <script src="{% static '/codemirror/mode/go/go.js' %}"></script>
  <script src="{% static '/codemirror/mode/clike/clike.js' %}"></script>
  <script src="{% static '/codemirror/mode/ruby/ruby.js' %}"></script>
  <script src="{% static '/codemirror/mode/perl/perl.js' %}"></script>
  <script src="{% static '/codemirror/mode/swift/swift.js' %}"></script>
  <script src="{% static '/codemirror/mode/pascal/pascal.js' %}"></script>
  <script src="{% static '/codemirror/mode/fortran/fortran.js' %}"></script>
  <script src="{% static '/codemirror/mode/javascript/javascript.js' %}"></script>
 
  <link rel="stylesheet" href="{% static '/codemirror/theme/panda-syntax.css' %}">
  
  <style>
    .CodeMirror {border-top: 1px solid #e5e5e5; border-bottom: 1px solid #e5e5e5;height:370px}
    .breakpoints {width: .8em;}
    .breakpoint { color: #822; }
    .CodeMirror {border: 1px solid #aaa;}
  </style>
  <link href="{% static '/css/bootstrap-editable.css' %}" rel="stylesheet">
        
{% endblock %}
{% block content %}
<!-- page content -->
<form class="form-horizontal form-label-left" method="post" action="../running/">
  <div class="right_col" role="main">
    <div class="col-md-4 col-sm-4 col-xs-12" id="debugdiv" >
      <div class="x_panel" id="debugpanel" style="display: none;" >

        <div class="accordion" id="accordion1" role="tablist" aria-multiselectable="true">
          <div class="panel" id="panel1" style="overflow-y:auto">
            <a class="panel-heading" role="tab" id="headingOne" data-toggle="collapse" data-parent="#accordion1" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
              <h4 class="panel-title">本地变量</h4>
            </a>
            <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne" aria-expanded="true" style="">
              <div class="panel-body">
                <table class="table" id='vartable'>

                  <tbody>
                  
                    
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="accordion" id="accordion2" role="tablist" aria-multiselectable="true">
          <div class="panel" id="panel2" style="overflow-y:auto">
            <a class="panel-heading " role="tab" id="headingTwo" data-toggle="collapse" data-parent="#accordion2" href="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
              <h4 class="panel-title">监视变量</h4>
            </a>
            <div id="collapseTwo" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingTwo" aria-expanded="true" >
              <div class="panel-body">
                  <table class="table" id="watchtable">
                    <tbody>
                      <td><a href="#" id="var1" data-type="text" data-pk="1" data-url="../debug/" data-title="Enter username">superuser</a></td>
                      <td><a href="#" id="var1value" data-type="text" data-pk="2" data-url="../debug/" data-title="Enter username"></a></td>
                      
                    </tbody>
                  </table>
              </div>
            </div>
          </div>
        </div>
        <div class="accordion" id="accordion3" role="tablist" aria-multiselectable="true">
          <div class="panel" id="panel3" style="overflow-y:auto">
            <a class="panel-heading " role="tab" id="headingThree" data-toggle="collapse" data-parent="#accordion3" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">
              <h4 class="panel-title">堆栈信息</h4>
            </a>
            <div id="collapseThree"  class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingThree" aria-expanded="true" >
              <div class="panel-body" >
                <table class="table" id="stacktable">
                  <thead>
                    <tr>
                      <th>行</th>
                      <th>位置</th>
                    </tr>
                  </thead>
                  <tbody>
                  
                    
                  </tbody>
                </table>              
              </div>
            </div>
          </div>
        </div>







      </div>
    </div>
    <div class="col-md-12 col-sm-12 col-xs-12" id="maindiv">
      <div class="x_panel" id="mainpanel">
          {% csrf_token %}
            <div class="x_content">
                <div class="form-group">
                    <h4  class="col-md-8 col-sm-8 col-xs-12"><a href="../detail/?id={{ issueid }}" target="blank">题目：{{ title }}</a></h4>
                    <label class="control-label col-md-2 col-sm-2 col-xs-12">语言</label>
                    <div class="col-md-2 col-sm-2 col-xs-12">
                      <select class="form-control" id="codetype" name="codetype">
                        <option value="python">Python</option>
                        <option value="text/x-go">GO</option>
                        <option value="text/x-c++src">C++</option>
                        <option value="text/x-csrc">C</option>
                        <option value="text/x-java">JAVA</option>
                        <option value="text/x-csharp">C#</option>
                        <option value="text/x-objectivec">Objective C</option>
                        <option value="text/x-swift">Swift</option>
                        <option value="text/x-ruby">Ruby</option>
                        <option value="text/x-perl">Perl</option>
                        <option value="text/x-fortran">Fortran</option>
                        <option value="text/x-pascal">Pascal</option>
                        <option value="text/typescript">JS</option>
                      </select>
                    </div>
                </div>
                <textarea id="codeid" class="form-control" name="code">

                </textarea>  
            </div>
            <div class="x_content">
              <div class="form-group">
                <label class="control-label col-md-1" >输入： 
                </label>
                <div class="col-md-5">
                  <textarea class="editor-wrapper form-control" id="stdin" ></textarea></div>

                <label class="control-label col-md-1" >输出：
                </label>
                <div class="col-md-5">
                    <textarea class="editor-wrapper form-control" id="stdout" ></textarea>
                </div>
              </div>
            </div>
            <div class="x_content">
              <div class="form-group">
                <div class="col-md-12 col-sm-12 col-xs-12">
                  <button class="btn btn-primary pull-left" type="button" id="save">保存</button>
                  <button type="reset" class="btn btn-danger pull-left" id="reset">重置</button>
                  <button class="btn btn-success pull-left" type="button" id="run">运行</button>
                  <button class="btn btn-warning pull-left" type="button" id="debug"><i class="fa fa-play"></i>调试</button>
                  <button style="display: none" class="btn btn-warning pull-left" type="button" id="debugcontinue"><i class="fa fa-play"></i>继续</button>
                  <button style="display: none" class="btn btn-warning pull-left" type="button" id="debugstop"><i class="fa fa-stop"></i>停止</button>
                  <button style="display: none" class="btn btn-warning pull-left" type="button" id="debugup"><i class="fa fa-arrow-up"></i>单步跳出</button>
                  <button style="display: none" class="btn btn-warning pull-left" type="button" id="debugdown"><i class="fa fa-arrow-down"></i>单步进入</button>
                  <label class="control-label " id="runtime"></label>
                  <button class="btn btn-success pull-right" type="button" id="submit">提交</button>
                  <span id="issue" style="visibility: hidden">{{ issueid }}</span>
                </div>
              </div>
            </div>
      </div>
    </div>
  </div>
 </form>
<!-- /page content -->
{% endblock %}
{% block js %}
<script src="{% static '/js/bootstrap-editable.min.js' %}"></script>

    <script>
      $(function(){
        //$.fn.editable.defaults.mode = 'inline'; 
        $('.nav_menu').hide();
        
        $('#var1').editable({
            url: '../debug/',
            type: 'text',
            name: 'setwatch',
            success: function(response, newValue) {
              if(response.result == true){
                $('#var1value').text(response.pdbresult);
              }
            }
        });
        $('#var1value').editable({
            url: '../debug/',
            type: 'text',
            name: 'setwatch',
            success: function(response, newValue) {
              if(response.result == true){
                $('#var1value').text(response.pdbresult);
              }
            }
        });
      });
      var editor = CodeMirror.fromTextArea(document.getElementById("codeid"), {
            mode: {name: $('#codetype').val(),
                  version: 3,
                  singleLineStringErrors: true},
                  lineNumbers: true,
                  gutters: ["CodeMirror-linenumbers", "breakpoints"],
                  indentUnit: 4,
                  styleActiveLine: true,
                  height: "100%",
                  smartIndent: true, // 智能缩进
                  indentWithTabs: true, // 使用制表符进行智能缩进
                  matchBrackets: true
        });
      editor.on("gutterClick", function(cm, n) {
        var info = cm.lineInfo(n);
        var obj = info.gutterMarkers ? null : makeMarker()
        var lines = [];
        lines.push(n+1);

        cm.setGutterMarker(n, "breakpoints", obj);
        if(debugging){
          $.post("../debug/", { 
                                  line:JSON.stringify(lines),
                                  action: obj ? 'addbreak':'removebreak'},
            function(data){
            });
        }
      });
      function makeMarker() {
        var marker = document.createElement("div");
        marker.style.color = "#822";
        marker.innerHTML = "●";
        return marker;
      }
      //更改语言
      function changcode() {
        var t = $('#codetype').val();
        var c ="";
        if(t == "python"){
          c = 'def factorial(x):\n  if x == 1:\n    print(x)\n    return x\n  y = x * factorial(x-1)\n  print(y)\n  return y\nprint()\nfactorial(10)';
        }else if(t == "text/x-go"){
          c = 'package main\n\nimport (\n    "fmt"\n    "os"\n)\n\nfunc main() {\n    fmt.Println(os.Args)\n}';
        }else if(t == "text/x-c++src"){
          c = '#include<iostream>\nusing namespace std;\n\nint main(int argc,char *argv[])\n{\n    for(int i=0;i<argc;i++)\n        cout<<argv[i]<<endl;\n}';
        }else if(t == "text/x-csrc"){
          c = '#include <stdio.h>\n\nint main(int argn,char **argv)\n{\n    printf("main input is %d %s",argn,*(argv+1));\n    return 0;\n}';
        }else if(t == "perl"){
          c = 'def factorial(x):\n  if x == 1:\n    print(x)\n    return x\n  y = x * factorial(x-1)\n  print(y)\n  return y\nprint()\nfactorial(10)';
        }else if(t == "text/x-ruby"){
          c = 'def main()\n   puts "Hello," + $*[0]\nend\nmain';
        }else if(t == "text/x-csharp"){
          c = 'class HelloMono\n { \n    public static void Main(string[ ] args) \n    {\n         System.Console.WriteLine(args[0]); \n    } \n}';
        }else if(t == "text/x-java"){
          c = 'public class VMargs {\n\n    public static void main(String[] args) {\n        String result = args[0];\n        System.out.println("my: " + result);\n    }\n}'
        }else if(t == "text/x-objectivec"){
          c = 'int main(int argc, const char * argv[])\n{\n    printf(argv[0]);\n    return 0;\n}';
        }else if(t == "text/x-swift"){
          c = 'print("my first swift ")';
        }else if(t == "text/x-perl"){
          c = '#!/usr/bin/perl\nsub Average{\n$n = scalar(@_);\n\n$sum = 0;\n   foreach $item (@_){\n      $sum += $item;\n   }\n   $average = $sum / $n;\n   print "传入的参数为 : ","@_\n";           # 打印整个数组\n}\nAverage(10, 20, 30);'
        }else if(t == "text/x-fortran"){
          c = 'PROGRAM test_get_command_argument\nInteger :: i,n\nCharacter(len=128) :: arg\ni = 0\nDO\nCALL get_command_argument(i, arg)\nIF (LEN_TRIM(arg) == 0) EXIT\nWRITE (*,*) i,arg\ni = i+1\nEND DO\nEND PROGRAM\n'
        }else if(t == "text/x-pascal"){
          c = 'program hello;\nbegin\n	writeln(\'hhh\')\nend.'
        }else if(t == "text/typescript"){
          c = 'function hello() {\nconsole.log(\'Hello World!\');\n}\nhello();'
        }
        
        editor.setOption("mode",t);
        editor.setValue(c);
      }
      $('#codetype').change(changcode);
      changcode();
      debugging = false;
      //run代码
      $('#run').click(function(){
        $('#run').attr("disabled",true); 
        $('#submit').attr("disabled",true); 
        //console.log($('#issue').text());
        $.post("../running/", { codetype: $('#codetype').val(), 
                                stdin: $('#stdin').val() ,
                                code: editor.getValue(),
                                issue: $('#issue').text()},
          function(data){
            $('#run').attr("disabled",false); 
            $('#submit').attr("disabled",false); 
            $('#stdout').val(data['stdout']['outdata']);
            
            $('#runtime').text('运行时间:' + data['stdout']['runtime']+'秒');
          });
      });
      //提交代码
      $('#submit').click(function(){
        $('#run').attr("disabled",true); 
        $('#submit').attr("disabled",true); 
        $('#runtime').text('');
        $.post("../submit/", { codetype: $('#codetype').val(), 
                                stdin: $('#stdin').val() ,
                                code: editor.getValue(),
                                issue: $('#issue').text()},
          function(data){
            console.log(data);
            $('#run').attr("disabled",false); 
            $('#submit').attr("disabled",false); 
            $('#stdout').val(data['stdout']);
          });
      });
      //开始调试
      $('#debug').click(function(){
        $('#stdout').val('');
        $('#runtime').text('');
        $("#vartable tr").remove();
        $("#stacktable tr:not(:first)").remove();
        debugging=true;
        $.post("../debug/", { codetype: $('#codetype').val(), 
                                stdin: $('#stdin').val() ,
                                code: editor.getValue(),
                                action:'debug',
                                breaks:JSON.stringify(getbreaks())
                            },
          function(data){
            console.log(data);
            if( data['result'] == true){
              editor.setCursor(Number(data['pdbresult'])-1);
              $('#debugstop').show();
              $('#debugup').show();
              $('#debugdown').show();
              $('#debugcontinue').show();
              $('#maindiv').toggleClass('col-md-12 col-sm-12');
              $('#maindiv').toggleClass('col-md-8 col-sm-8');

              $('#debugpanel').show();

              $('#debug').hide();
              $('#save').hide();
              $('#reset').hide();
              $('#run').hide();
              $('#submit').hide();
              $('#debugpanel').css("height",$('#mainpanel').height()+22);
              $('#panel1').css("height",$('#debugpanel').height()/3)
              $('#panel2').css("height",$('#debugpanel').height()/3)
              $('#panel3').css("height",$('#debugpanel').height()/3)
            }else{
              debugging=false;
            }
            $('#stdout').val(data['appresult']);
          });
      });
      //停止调试
      $('#debugstop').click(function(){
        debugging=false;
          $.post("../debug/", { 
                                action:'stop'
                              },
          function(data){
            console.log(data);

              $('#debugstop').hide();
              $('#debugup').hide();
              $('#debugdown').hide();
              $('#debugcontinue').hide();
              $('#debugpanel').hide();
              $('#maindiv').toggleClass('col-md-8 col-sm-8');
              $('#maindiv').toggleClass('col-md-12 col-sm-12');
              
              
              $('#debug').show();
              $('#save').show();
              $('#reset').show();
              $('#run').show();
              $('#submit').show();
            
          });
      });
      //单步进入
      $('#debugdown').click(function(){
          $.post("../debug/", { 
                                action:'stepinto'
                              },
          function(data){
            console.log(data);
            if( data['result']  == true){
              old = $('#stdout').val();
              $('#stdout').val( old + data['appresult']);

              if(data['pdbresult'] == 'end'){
                debugging=false;
                editor.setCursor(0)
                $('#debugstop').hide();
                $('#debugup').hide();
                $('#debugdown').hide();
                $('#debugcontinue').hide();
                $('#debugpanel').hide();
                $('#maindiv').toggleClass('col-md-8 col-sm-8');
                $('#maindiv').toggleClass('col-md-12 col-sm-12');
                
                $('#debug').show();
                $('#save').show();
                $('#reset').show();
                $('#run').show();
                $('#submit').show();
              }else{
                editor.setCursor(Number(data['pdbresult'])-1);
                showvars(data['localvars'])
                showstacks(data['stacks'])
              }
            }
          });
      });
      //单步跳过
      $('#debugup').click(function(){
          $.post("../debug/", { 
                                action:'stepover'
                              },
          function(data){
            console.log(data);
            if( data['result'] == true){
              old = $('#stdout').val();
              $('#stdout').val( old + data['appresult']);
              
              if(data['pdbresult'] == 'end'){
                debugging=false;
                editor.setCursor(0)
                $('#debugstop').hide();
                $('#debugup').hide();
                $('#debugdown').hide();
                $('#debugcontinue').hide();
                $('#debugpanel').hide();
                $('#maindiv').toggleClass('col-md-8 col-sm-8');
                $('#maindiv').toggleClass('col-md-12 col-sm-12');

                $('#debug').show();
                $('#save').show();
                $('#reset').show();
                $('#run').show();
                $('#submit').show();
              }else{
                editor.setCursor(Number(data['pdbresult'])-1);
                showvars(data['localvars'])
                showstacks(data['stacks'])
              }
            }
          });
      });
      //继续
      $('#debugcontinue').click(function(){
          $.post("../debug/", { 
                                action:'continue'
                              },
          function(data){
            console.log(data);
            if( data['result'] == true){
              old = $('#stdout').val();
              $('#stdout').val( old + data['appresult']);
              
              if(data['pdbresult'] == 'end'){
                debugging=false;
                editor.setCursor(0)
                $('#debugstop').hide();
                $('#debugup').hide();
                $('#debugdown').hide();
                $('#debugcontinue').hide();
                $('#debugpanel').hide();
                $('#maindiv').toggleClass('col-md-8 col-sm-8');
                $('#maindiv').toggleClass('col-md-12 col-sm-12');

                $('#debug').show();
                $('#save').show();
                $('#reset').show();
                $('#run').show();
                $('#submit').show();
              }else{
                editor.setCursor(Number(data['pdbresult'])-1);
                showvars(data['localvars'])
                showstacks(data['stacks'])
              }
            }
          });


      });
      //添加断点
      function getbreaks(){
        var lines=[];
        linecount = editor.lineCount();
        for( i = 0 ;i<linecount;i++){
          var info = editor.lineInfo(i);
          if (info.gutterMarkers){
            lines.push(i+1);
          } 
        }
        return lines;
      }
      function showvars(data){
        $("#vartable tr").remove();
        for(var key in data){
          $("#vartable>tbody").after('<tr><td>'+key +'：</td><td>'+data[key]+'</td></tr>');
        }
      }
      function showstacks(data){
        $("#stacktable tr:not(:first)").remove();
        for(var item = data.length - 1 ; item >=0 ; item--){
          $("#stacktable tr:last").after('<tr><td>*'+ data[item]['line'] +'：</td><td>'+data[item]['function']+'</td></tr>');
        }
      }
      //重置运行时间
      $('#reset').click(function(){
        $('#runtime').text('');
      })
    </script>
{% endblock %}
